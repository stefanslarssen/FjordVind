openapi: 3.0.3
info:
  title: FjordVind Lusevokteren API
  description: |
    REST API for sea lice monitoring in Norwegian aquaculture.

    ## Authentication
    Most endpoints require authentication via JWT Bearer token.

    ```
    Authorization: Bearer <your-token>
    ```

    ## Demo Mode
    In development, demo tokens are available:
    - `demo_token_admin` - Admin access
    - `demo_token_driftsleder` - Operations manager
    - `demo_token_røkter` - Fish farmer

  version: 1.1.0
  contact:
    name: FjordVind Support
    email: support@fjordvind.no
  license:
    name: MIT

servers:
  - url: http://localhost:3000
    description: Development server
  - url: https://api.fjordvind.no
    description: Production server

tags:
  - name: Auth
    description: Authentication and user management
  - name: Samples
    description: Lice count samples and fish observations
  - name: Treatments
    description: Treatment management
  - name: Alerts
    description: Alert system
  - name: Mortality
    description: Mortality tracking
  - name: Environment
    description: Environmental readings
  - name: Locations
    description: Location management
  - name: Merds
    description: Cage/merd management
  - name: Dashboard
    description: Dashboard statistics
  - name: Predictions
    description: Lice predictions and risk scores

paths:
  /health:
    get:
      summary: Health check
      description: Check if the API is running
      tags: [System]
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  message:
                    type: string
                    example: Lusevokteren API is running

  # ========== AUTH ==========
  /api/auth/register:
    post:
      summary: Register new user
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '409':
          description: User already exists

  /api/auth/login:
    post:
      summary: Login
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials

  /api/auth/me:
    get:
      summary: Get current user
      tags: [Auth]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Not authenticated

  /api/auth/refresh:
    post:
      summary: Refresh token
      tags: [Auth]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: New token
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  message:
                    type: string

  /api/auth/logout:
    post:
      summary: Logout
      tags: [Auth]
      responses:
        '200':
          description: Logged out

  # ========== SAMPLES ==========
  /api/samples:
    get:
      summary: List samples
      tags: [Samples]
      security:
        - bearerAuth: []
      parameters:
        - name: merd_id
          in: query
          schema:
            type: string
            format: uuid
        - name: start_date
          in: query
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          schema:
            type: string
            format: date
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of samples
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  samples:
                    type: array
                    items:
                      $ref: '#/components/schemas/Sample'

    post:
      summary: Create sample
      tags: [Samples]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSampleRequest'
      responses:
        '201':
          description: Sample created
        '400':
          description: Validation error

  /api/samples/{id}:
    get:
      summary: Get sample by ID
      tags: [Samples]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Sample data
        '404':
          description: Sample not found

  # ========== TREATMENTS ==========
  /api/treatments:
    get:
      summary: List treatments
      tags: [Treatments]
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [planlagt, pågår, fullført, kansellert]
        - name: merd_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of treatments

    post:
      summary: Create treatment
      tags: [Treatments]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTreatmentRequest'
      responses:
        '201':
          description: Treatment created

  /api/treatments/{id}:
    get:
      summary: Get treatment by ID
      tags: [Treatments]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Treatment data
        '404':
          description: Treatment not found

    put:
      summary: Update treatment
      tags: [Treatments]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTreatmentRequest'
      responses:
        '200':
          description: Treatment updated

  # ========== ALERTS ==========
  /api/alerts:
    get:
      summary: List alerts
      tags: [Alerts]
      security:
        - bearerAuth: []
      parameters:
        - name: severity
          in: query
          schema:
            type: string
            enum: [INFO, WARNING, CRITICAL]
        - name: is_read
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: List of alerts

  /api/alerts/{id}/read:
    post:
      summary: Mark alert as read
      tags: [Alerts]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Alert marked as read

  # ========== MORTALITY ==========
  /api/mortality:
    get:
      summary: List mortality records
      tags: [Mortality]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of mortality records

    post:
      summary: Create mortality record
      tags: [Mortality]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMortalityRequest'
      responses:
        '201':
          description: Mortality record created

  # ========== ENVIRONMENT ==========
  /api/environment:
    get:
      summary: List environment readings
      tags: [Environment]
      security:
        - bearerAuth: []
      parameters:
        - name: merd_id
          in: query
          schema:
            type: string
            format: uuid
        - name: hours
          in: query
          schema:
            type: integer
            default: 24
      responses:
        '200':
          description: List of readings

    post:
      summary: Create environment reading
      tags: [Environment]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEnvironmentRequest'
      responses:
        '201':
          description: Reading created

  # ========== LOCATIONS ==========
  /api/locations:
    get:
      summary: List locations
      tags: [Locations]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of locations

  # ========== MERDS ==========
  /api/merds:
    get:
      summary: List merds/cages
      tags: [Merds]
      security:
        - bearerAuth: []
      parameters:
        - name: locality_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of merds

  # ========== DASHBOARD ==========
  /api/stats:
    get:
      summary: Get dashboard statistics
      tags: [Dashboard]
      responses:
        '200':
          description: Dashboard stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalCounts:
                    type: integer
                  todayCounts:
                    type: integer
                  avgAdultFemale:
                    type: number
                  aboveThreshold:
                    type: integer

  /api/stats/lice-trend:
    get:
      summary: Get lice trend data
      tags: [Dashboard]
      parameters:
        - name: days
          in: query
          schema:
            type: integer
            default: 14
      responses:
        '200':
          description: Trend data

  /api/dashboard/overview:
    get:
      summary: Dashboard overview
      tags: [Dashboard]
      responses:
        '200':
          description: Overview data

  # ========== PREDICTIONS ==========
  /api/predictions:
    get:
      summary: List predictions
      tags: [Predictions]
      parameters:
        - name: riskLevel
          in: query
          schema:
            type: string
            enum: [LOW, MEDIUM, HIGH, CRITICAL]
      responses:
        '200':
          description: List of predictions

  /api/predictions/summary:
    get:
      summary: Prediction summary
      tags: [Predictions]
      responses:
        '200':
          description: Summary data

  /api/risk-scores:
    get:
      summary: Risk scores
      tags: [Predictions]
      responses:
        '200':
          description: Risk scores

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    RegisterRequest:
      type: object
      required:
        - email
        - password
        - full_name
      properties:
        email:
          type: string
          format: email
          example: user@example.no
        password:
          type: string
          minLength: 8
          example: securepassword123
        full_name:
          type: string
          example: Ola Nordmann
        company_name:
          type: string
          example: Fjordbruk AS
        org_number:
          type: string
          pattern: '^\d{9}$'
          example: '123456789'

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthResponse:
      type: object
      properties:
        token:
          type: string
        user:
          $ref: '#/components/schemas/User'
        message:
          type: string

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
        full_name:
          type: string
        role:
          type: string
          enum: [admin, driftsleder, røkter, viewer]
        company_id:
          type: string
          format: uuid

    UserResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'

    ValidationError:
      type: object
      properties:
        error:
          type: string
          example: Valideringsfeil
        details:
          type: array
          items:
            type: string

    Sample:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sample_id:
          type: string
        merd_id:
          type: string
          format: uuid
        dato:
          type: string
          format: date
        antall_fisk:
          type: integer
        temperatur:
          type: number
        fish_observations:
          type: array
          items:
            $ref: '#/components/schemas/FishObservation'

    FishObservation:
      type: object
      properties:
        fish_id:
          type: string
        voksne_hunnlus:
          type: integer
        bevegelige_lus:
          type: integer
        fastsittende_lus:
          type: integer

    CreateSampleRequest:
      type: object
      required:
        - merd_id
        - dato
        - antall_fisk
      properties:
        merd_id:
          type: string
          format: uuid
        dato:
          type: string
          format: date
        antall_fisk:
          type: integer
          minimum: 1
        temperatur:
          type: number
        notat:
          type: string
        fish_observations:
          type: array
          items:
            type: object
            properties:
              voksne_hunnlus:
                type: integer
              bevegelige_lus:
                type: integer
              fastsittende_lus:
                type: integer

    CreateTreatmentRequest:
      type: object
      required:
        - treatment_type
        - scheduled_date
      properties:
        merd_id:
          type: string
          format: uuid
        locality_name:
          type: string
        treatment_type:
          type: string
          enum: [Hydrogenperoksid, Termisk, Mekanisk, Rensefisk, Ferskvann, Imidakloprid]
        scheduled_date:
          type: string
          format: date
        notes:
          type: string

    UpdateTreatmentRequest:
      type: object
      properties:
        status:
          type: string
          enum: [planlagt, pågår, fullført, kansellert]
        completed_date:
          type: string
          format: date
        lice_after:
          type: number
        effectiveness_percent:
          type: number
        notes:
          type: string

    CreateMortalityRequest:
      type: object
      required:
        - merd_id
        - record_date
      properties:
        merd_id:
          type: string
          format: uuid
        record_date:
          type: string
          format: date
        salmon_dead:
          type: integer
        salmon_cause:
          type: string
        cleaner_fish_dead:
          type: integer
        mortality_category:
          type: string
          enum: [normal, behandling, sykdom, håndtering, predator, miljø, annet]

    CreateEnvironmentRequest:
      type: object
      required:
        - merd_id
      properties:
        merd_id:
          type: string
          format: uuid
        temperature_celsius:
          type: number
        oxygen_percent:
          type: number
        salinity_ppt:
          type: number
        ph:
          type: number
